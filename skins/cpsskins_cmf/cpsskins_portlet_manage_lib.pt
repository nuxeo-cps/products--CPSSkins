<metal:block define-macro="box">
  <div
   tal:define="ypos portlet/getOrder;
               portlet_id portlet/getId;
               portlet_url portlet/getURL;
               portlet_title portlet/title_or_id;
               portlet_folder portlet/getLocalFolder;
               portlet_rurl portlet/getRelativeUrl;
               fti portlet/getTypeInfo;
               portlet_type fti/title_or_id;
               portlet_icon fti/getIcon;
               portlet_folder portlet/getLocalFolder;
               portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
               editable python:checkPerm('Manage Portlets', portlet);
               box_selected python: portlet == here or portlet_id == selected_portlet"
   tal:attributes="portlet_rurl portlet_rurl;
                   src_rurl portlet_folder_rurl;
                   src_ypos python: ypos and ypos or 0;
                   src_slot group;
                   class python: editable and 'BoxGroupBoxSlot PortletBoxDrag' or 'BoxGroupBoxSlot'">
    <div class="PortletBoxDest"
     tal:define="box_style python: box_selected and 'border: 1px dashed Black' or 'border: none'"
      tal:attributes="style box_style;
                      dest_rurl portlet_folder_rurl;
                      dest_slot group;
                      dest_ypos python: ypos and ypos or 0">
      <div tal:attributes="class slot_class">
      <div class="title BoxGroupBoxTitle"
       tal:condition="editable" style="display:block; padding-right: 0">
        <a style="float:right"  href=""
        tal:attributes="href string:${portlet_folder/absolute_url}/cpsskins_delete_portlet?portlet_id=$portlet_id&redirect_url=$folder_url; 
                        onclick python:'return window.confirm(\'%s\')' % (cpsmcat('description_confirm_delete_portlet'), )">
          <img border="0" width="12" height="12" alt=""
          tal:attributes="src string:${base_url}cpsskins_images/img_delete.png" />
        </a>
        <a tal:attributes="href string:${portlet_url}/cpsskins_portlet_edit">
          <tal:block content="portlet_title" />
        </a>
      </div>
      <div class="BoxGroupBoxBody PortletBoxEditMenu"
       tal:attributes="portlet_id portlet_id;
                       portlet_folder python: base_url + portlet_folder_rurl;
                       folder_url folder_url;
                       src_ypos python: ypos and ypos or 0;
                       src_slot group">
        <div class="body">
          <img width="16" height="16" alt=""
          tal:condition="portlet_icon"
          tal:attributes="src string:${base_url}${portlet_icon}" />
          <em tal:content="structure python: cpsmcat(portlet_type)" />
          <p>
            <tal:block i18n:translate="listingheader_location" />:
            <em tal:content="python: '/' + portlet_folder.absolute_url(1)" />
          </p>
        </div>
      </div>
      </div>
    </div>
  </div>
</metal:block>

<metal:block define-macro="contextual_menu" i18n:domain="cpsskins"
  tal:define="ttool here/portal_types">
  <div id="choice-context-menu" class="context-menu">
    <div class="context-menu-header"
         filter="Portlet_prepare_element_menu(pd_filter_object)"></div>
    <div class="context-menu-item" onmouseup="Choice_insert()"
         filter="pd_selected_item">
       <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/insert-16.png" />
       <tal:block i18n:translate="" 
         define="title string:_menu_Insert_"
         content="python: mcat and mcat(title) or title" />
    </div>
    <div class="context-menu-item" onmouseup="Choice_delete()"
         filter="pd_selected_item">
       <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/delete-16.png" />
       <tal:block i18n:translate="" 
         define="title string:_menu_Delete_"
         content="python: mcat and mcat(title) or title" />
    </div>
  </div>
</metal:block>

<metal:block define-macro="fullscreen" i18n:domain="cpsskins">
  <div class="PortletsFullscreen">
    <form class="ViewMode" action="" method="post" 
     tal:condition="not:fullscreen"
     tal:attributes="action string:${tmtool/absolute_url}/setViewMode">
      <input type="hidden" name="fullscreen" value="1" />
      <input class="Fullscreen"
        type="submit" value="_button_fullscreen_" i18n:attributes="value" />
    </form>
    <form class="ViewMode" action="" method="post"
     tal:condition="fullscreen"
     tal:attributes="action string:${tmtool/absolute_url}/setViewMode">
      <input type="hidden" name="fullscreen" value="0" />
      <input class="NoFullscreen"
       type="submit" value="_button_normal_mode_" i18n:attributes="value" />
    </form>
  </div>
</metal:block>

<metal:block define-macro="panel_selector" i18n:domain="cpsskins">
  <form class="PortletsPanelSelector"
   action="" method="post" style="text-align:right"
   tal:attributes="action string:${tmtool/absolute_url}/setViewMode">
    <select name="portlets_panel" onchange="submit()">
      <option value="" disabled="disabled" selected="selected">Select a panel ...</option>
      <option value="main_canvas">Main canvas</option>
      <option value="site_structure">Site structure</option>
      <option value="unused">Unused portlets</option>
      <option value="browser">Portlet browser</option>
    </select>
  </form>
</metal:block>

<metal:block define-macro="empty_slot">
  <div class="PortletBoxDest" style="margin:4px"
   tal:condition="python:len(portlets) == 0"
   tal:attributes="dest_slot group; 
   dest_ypos python: 0">
    <div class="PortletBoxEditMenu" style="padding: 20px"
     tal:attributes="src_ypos python: 0;
                     src_slot group"></div>
  </div>
</metal:block>

<metal:block define-macro="box_slot">
    <tal:block repeat="portlet portlets"
     define="slot_class string:BoxColor${content/boxcolor|nothing} BoxShape${content/boxshape|nothing}">
      <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box" />
    </tal:block>
</metal:block>

<metal:block define-macro="main_canvas">
  <tal:block repeat="block python: tmtool.getPageBlocks(theme=current_theme)">
    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slots" />
  </tal:block>
</metal:block>

<metal:block define-macro="box_slots">
  <table cellpadding="0" cellspacing="3" width="100%">
    <tr valign="top"
     tal:define="objects python: block.getObjects(); 
                 maxcols block/maxcols|nothing">
      <tal:block condition="maxcols"
       repeat="x_pos python: range(int(maxcols))">
        <tal:block define="objects_in_xpos python: objects.get(x_pos, None);
                           contents_in_xpos python: objects_in_xpos['contents'];
                           cellsize python: objects_in_xpos['cellsizer'];
                           cellwidth cellsize/cellwidth|nothing"
                   condition="contents_in_xpos">
          <td tal:attributes="width cellwidth">
            <tal:block repeat="content contents_in_xpos">
              <div class="TempletBox" tal:content="content/title"
               tal:condition="content/aq_explicit/isPortalBox|nothing" />
              <tal:block condition="content/aq_explicit/isPortalBoxGroup|nothing"
               define="group content/box_group|nothing">
                <div class="BoxGroupBoundingBox"
                 tal:define="slot_icon python: '/' + content.getIcon();
                             slot_title python: content.Title()">
                  <div tal:content="group" class="BoxGroupBoxSlotTitle" />
                  <tal:block define="portlets python:ptltool.getPortlets(context=here, slot=group)">
                    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slot" />
                    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/empty_slot" />
                  </tal:block>
                </div>
              </tal:block>
              <tal:block condition="content/aq_explicit/isCellBlock|nothing">
                <tal:block define="block content">
                  <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slots" />
                </tal:block>
              </tal:block>
            </tal:block>
          </td>
        </tal:block>
      </tal:block>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="unused_portlets_panel">
  <h2 i18n:translate="heading_unused_portlets" i18n:domain="cpsskins">Unused portlets</h2>
  <p i18n:translate="description_unused_portlets" i18n:domain="cpsskins">Unused portlets</p>
  <table cellpadding="0" cellspacing="3">
    <tr>
      <td valign="top" tal:repeat="hidden_slot hidden_slots">
        <div class="BoxGroupBoundingBox" 
         tal:define="group hidden_slot">
          <div tal:content="hidden_slot"
           class="BoxGroupBoxSlotTitleHidden">
          </div>
          <tal:block define="portlets python:ptltool.getPortlets(here, hidden_slot)">
            <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slot" />
            <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/empty_slot" />
          </tal:block>
        </div>
      </td>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="site_structure"
  tal:define="here_depth python: len(utool.getRelativeContentPath(here))">
  <h2 i18n:translate="heading_site_structure" i18n:domain="cpsskins">Site structure</h2>
  <p><span i18n:translate="description_portlets_visible_from">Portlets visible from</span>
    <span tal:content="context_url" />
  </p>
  <table border=0 width="100%" cellpadding="3" cellspacing="2">
    <tr>
      <th tal:repeat="bc here/cpsskins_getBreadcrumbs">
        <a href="" tal:content="bc/longtitle" 
         tal:attributes="href string:/${bc/rpath}/portlet_manage_form" />
      </th>
    </tr>
    <tal:block define="portlets python:ptltool.getPortlets(context=here)"
               repeat="portlet portlets">
      <tr tal:define="ypos portlet/getOrder;
                      fti portlet/getTypeInfo;
                      portlet_id portlet/getId;
                      portlet_type fti/title_or_id;
                      portlet_icon fti/getIcon;
                      portlet_url portlet/getURL;
                      portlet_folder portlet/getLocalFolder;
                      portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
                      portlet_rurl portlet/getRelativeUrl;
                      portlet_depth portlet/getDepth;
                      group portlet/getSlot;
                      vrange portlet/getVisibilityRange;
                      vrange_start python: vrange[0];
                      vrange_stop python: vrange[1];
                      selected python: portlet_id == selected_portlet">
        <td tal:condition="portlet_depth"
         tal:attributes="colspan python: portlet_depth"></td>
        <td style="border-bottom: 1px dotted #ccc">
          <div class="PortletBoxDrag"
           tal:attributes="portlet_rurl portlet_rurl;
                           src_rurl portlet_folder_rurl;
                           src_ypos python: ypos and ypos or 0;
                           src_slot group">
            <div class="PortletBoxDest"
             tal:attributes="dest_rurl portlet_folder_rurl;
                             dest_slot group;
                             dest_ypos python: ypos and ypos or 0">
              <div class="PortletInfo"
               tal:attributes="style python: selected and 'border-style: dashed' or ''">
                <a tal:content="portlet/title_or_id"
                 tal:attributes="href string:${portlet/absolute_url}/edit_form" />
                <p>
                  <img width="16" height="16" alt=""
                   tal:condition="portlet_icon"
                   tal:attributes="src string:${base_url}${portlet_icon};
                                   title python: cpsmcat(portlet_type)" />
                  <em tal:content="structure python: cpsmcat(portlet_type)" />.
                  <span tal:content="portlet/description" />
                </p>
              </div>
            </div>
          </div>
        </td> 
        <td style="border-bottom: 1px solid #ccc"
         tal:condition="python: here_depth != portlet_depth"
         tal:attributes="colspan python: here_depth - portlet_depth">
        </td> 
      </tr>       
    </tal:block> 
  </table>    
</metal:block>

<metal:block define-macro="browser_panel">
  <h2 i18n:translate="heading_portlet_browser" i18n:domain="cpsskins">Portlet browser</h2>
  <tal:block define="portlets ptltool/listAllPortlets"
             repeat="portlet portlets">
    <tal:block define="ypos portlet/getOrder;
                       fti portlet/getTypeInfo;
                       portlet_id portlet/getId;
                       portlet_type fti/title_or_id;
                       portlet_icon fti/getIcon;
                       portlet_url portlet/getURL;
                       portlet_folder portlet/getLocalFolder;
                       portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
                       portlet_rurl portlet/getRelativeUrl;
                       group portlet/getSlot;
                       selected python: portlet_id == selected_portlet">
      <div class="PortletBoxCopyDrag" style="padding: 2px"
       tal:attributes="portlet_rurl portlet_rurl;
                       src_rurl portlet_folder_rurl;
                       src_ypos python: ypos and ypos or 0;
                       src_slot group">
        <div class="PortletInfo"
         tal:attributes="style python: selected and 'border-style: dashed' or ''">
          <a tal:content="portlet/title_or_id"
           tal:attributes="href string:${portlet/absolute_url}/edit_form" />
          <p>
            <img width="16" height="16" alt=""
             tal:condition="portlet_icon"
             tal:attributes="src string:${base_url}${portlet_icon};
                             title python: cpsmcat(portlet_type)" />
            <em tal:content="structure python: cpsmcat(portlet_type)" />.
            <span tal:content="portlet/description" />
          </p>
        </div>
      </div>
    </tal:block>
  </tal:block>
</metal:block>
