<metal:block define-macro="box">
  <div
   tal:define="ypos portlet/getOrder;
               portlet_id portlet/getId;
               portlet_url portlet/getURL;
               portlet_title portlet/title_or_id;
               portlet_folder portlet/getLocalFolder;
               portlet_rurl portlet/getRelativeUrl;
               fti portlet/getTypeInfo;
               portlet_type fti/title_or_id;
               portlet_icon fti/getIcon;
               portlet_folder portlet/getLocalFolder;
               portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
               folder_url python: base_url + utool.getRelativeUrl(here);
               editable python:checkPerm('Manage Portlets', portlet);
               box_selected python: portlet == here or portlet_id == selected_portlet"
   tal:attributes="portlet_rurl portlet_rurl;
                   src_rurl portlet_folder_rurl;
                   src_ypos python: ypos and ypos or 0;
                   src_slot group;
                   class python: editable and 'BoxGroupBoxSlot PortletBoxDrag' or 'BoxGroupBoxSlot'">
    <div class="PortletBoxDest"
     tal:define="box_style python: box_selected and 'border: 1px dashed Black' or 'border: none'"
      tal:attributes="style box_style;
                      dest_slot group;
                      dest_ypos python: ypos and ypos or 0">
      <div tal:attributes="class slot_class">
      <div class="title BoxGroupBoxTitle"
       tal:condition="editable" style="display:block; padding-right: 0">
        <a style="float:right"  href=""
        tal:attributes="href string:${base_url}${portlet_folder_rurl}/cpsskins_delete_portlet?portlet_id=$portlet_id&redirect_url=$folder_url; 
                        onclick python:'return window.confirm(\'%s\')' % (cpsmcat('description_confirm_delete_portlet'), )">
          <img border="0" width="12" height="12" alt=""
          tal:attributes="src string:${base_url}cpsskins_images/img_delete.png" />
        </a>
        <a tal:attributes="onclick string:newWindow('${base_url}${portlet_rurl}/cpsskins_portlet_edit')"
         tal:content="portlet/title_or_id" href="javascript:void(0)"/>
      </div>
      <div class="BoxGroupBoxBody PortletBoxEditMenu"
       tal:attributes="portlet_id portlet_id;
                       portlet_url string:${base_url}${portlet_rurl};
                       portlet_folder python: base_url + portlet_folder_rurl;
                       icon portlet_icon;
                       title portlet_title;
                       folder_url folder_url;
                       src_ypos python: ypos and ypos or 0;
                       src_slot group">
        <div class="body">
          <img width="16" height="16" alt=""
          tal:condition="portlet_icon"
          tal:attributes="src string:${base_url}${portlet_icon}" />
          <em tal:content="structure python: cpsmcat(portlet_type)" />
          <p>
            <tal:block i18n:translate="listingheader_location" />:
            <em tal:content="python: '/' + portlet_folder.absolute_url(1)" />
          </p>
        </div>
      </div>
      </div>
    </div>
  </div>
</metal:block>

<metal:block define-macro="portlet_add_panel">
  <table class="contentbox" cellpadding="2" cellspacing="1"
   tal:define="til here/cpsskins_listPortlets">
    <tr>
      <tal:block repeat="ti til">
        <td class="PortletAdd"
         tal:attributes="ptype_id ti/id">
          <img tal:define="title ti/Title" width="16" height="16"
           i18n:attributes="title"
           tal:attributes="src string:${base_url}${ti/getIcon};
                           title title" /><br/>
        </td>
      </tal:block>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="contextual_menu" i18n:domain="cpsskins"
  tal:define="ttool here/portal_types;
              view_mode python: tmtool.getViewMode();
              clipboard view_mode/clipboard|nothing">
  <div id="choice-context-menu" class="context-menu">
    <div class="context-menu-header"
         filter="Portlet_prepare_element_menu(pd_filter_object)"></div>
    <div class="context-menu-item" onmouseup="Choice_edit()"
     tal:attributes="filter string:pd_selected_item && pd_selected_item.getAttribute('portlet_id')">
      <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/edit-16.png" />
      <tal:block i18n:translate="" 
         define="title string:_menu_Edit_"
         content="python: mcat and mcat(title) or title" />
    </div>
    <div class="context-menu-item" onmouseup="Choice_copy_to_clipboard()"
     tal:attributes="filter string:pd_selected_item && pd_selected_item.getAttribute('portlet_id')">
      <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/copy-16.png" />
      <tal:block i18n:translate="" 
         define="title string:_menu_Copy_"
         content="python: mcat and mcat(title) or title" />
    </div>
    <div class="context-menu-item" onmouseup="Choice_paste_from_clipboard()"
     tal:condition="clipboard"
     tal:attributes="filter string:pd_selected_item">
      <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/paste-16.png" />
      <tal:block i18n:translate="" 
         define="title string:_menu_Paste_"
         content="python: mcat and mcat(title) or title" />
    </div>
    <div class="context-menu-item" onmouseup="Choice_insert()"
         filter="pd_selected_item">
       <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/insert-16.png" />
       <tal:block i18n:translate="" 
         define="title string:_menu_Insert_"
         content="python: mcat and mcat(title) or title" />
    </div>
    <div class="context-menu-item" onmouseup="Choice_delete()"
     tal:attributes="filter string:pd_selected_item && pd_selected_item.getAttribute('portlet_id')">
       <img width="16" height="16" 
         tal:attributes="src string:${base_url}cpsskins_images/delete-16.png" />
       <tal:block i18n:translate="" 
         define="title string:_menu_Delete_"
         content="python: mcat and mcat(title) or title" />
    </div>
  </div>
</metal:block>

<metal:block define-macro="navigate"
tal:define="sections python: [ 'wysiwyg', 'portlet_slots', 'site_structure', 'portlet_browser', 'unused_portlets' ];
            view_mode tmtool/getViewMode;
            panel view_mode/portlets_panel|nothing;
            utool nocall:here/portal_url;
            tmtool_url python: base_url + utool.getRelativeUrl(tmtool)">
  <div class="mainformtab">
    &nbsp;
    <tal:block repeat="section sections">
      <a
      tal:define="url string:${tmtool_url}/setViewMode?portlets_panel=$section;
                  title python:'%s_panel' % section" i18n:translate=""
       tal:attributes="href url; class python: panel == section and 'selected' or None;"
      tal:content="python:mcat and mcat(title) or title" />
    </tal:block>
    &nbsp;
    <a tal:attributes="href string:${here_url}"
       tal:define="title string:_Exit_" i18n:translate=""
       tal:content="python:mcat and mcat(title) or title" />
 </div>
</metal:block>

<metal:block define-macro="clipboard" i18n:domain="cpsskins">
  <div class="ClipboardBox"
    tal:define="view_mode python: tmtool.getViewMode();
                clipboard view_mode/clipboard|nothing"
    tal:condition="clipboard">
    <strong i18n:translate=""
     tal:define="title string:_clipboard_"
     tal:content="python: mcat and mcat(title) or title" />
    <div tal:define="portal_path python: utool.getPortalPath();
                     portlet python: here.restrictedTraverse(portal_path + '/' + clipboard, default=None)"
     tal:condition="nocall:portlet">
      <div class="PortletBoxDrag"
       tal:define="ypos portlet/getOrder;
                   portlet_folder portlet/getLocalFolder;
                   portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
                   portlet_rurl portlet/getRelativeUrl;
                   portlet_depth portlet/getDepth"
       tal:attributes="copy python: 1;
                       portlet_rurl portlet_rurl;
                       src_rurl portlet_folder_rurl;
                       src_ypos python: ypos and ypos or 0;
                       src_slot portlet/getSlot;">
        <img src="" width="16" height="16" alt="" align="middle"
         tal:attributes="src python: '/' + portlet.getIcon()" />
        <span tal:content="portlet/title_or_id" />
      </div>
    </div>
  </div>
</metal:block>

<metal:block define-macro="empty_slot">
  <div class="PortletBoxDest" style="margin:4px"
   tal:condition="python:len(portlets) == 0"
   tal:attributes="dest_slot group; 
   dest_ypos python: 0">
    <div class="PortletBoxEditMenu" style="padding: 20px"
     tal:attributes="src_ypos python: 0;
                     src_slot group">
    </div>
  </div>
</metal:block>

<metal:block define-macro="box_slot">
    <tal:block repeat="portlet portlets"
     define="slot_class string:BoxColor${content/boxcolor|nothing} BoxShape${content/boxshape|nothing}">
      <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box" />
    </tal:block>
</metal:block>

<metal:block define-macro="main_canvas">
  <tal:block repeat="block python: tmtool.getPageBlocks(theme=current_theme)">
    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slots" />
  </tal:block>
</metal:block>

<metal:block define-macro="box_slots">
  <table cellpadding="0" cellspacing="3" width="100%">
    <tr valign="top"
     tal:define="objects python: block.getObjects(); 
                 maxcols block/maxcols|nothing">
      <tal:block condition="maxcols"
       repeat="x_pos python: range(int(maxcols))">
        <tal:block define="objects_in_xpos python: objects.get(x_pos, None);
                           contents_in_xpos python: objects_in_xpos['contents'];
                           cellsize python: objects_in_xpos['cellsizer'];
                           cellwidth cellsize/cellwidth|nothing"
                   condition="contents_in_xpos">
          <td tal:attributes="width cellwidth">
            <tal:block repeat="content contents_in_xpos">
              <div class="TempletBox" tal:content="content/title"
               tal:condition="content/aq_explicit/isPortalBox|nothing" />
              <tal:block condition="content/aq_explicit/isPortalBoxGroup|nothing"
               define="group content/box_group|nothing">
                <div class="BoxGroupBoundingBox"
                 tal:define="slot_icon python: '/' + content.getIcon();
                             slot_title python: content.Title()">
                  <div tal:content="group" class="BoxGroupBoxSlotTitle" />
                  <tal:block define="portlets python:ptltool.getPortlets(context=here, slot=group)">
                    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slot" />
                    <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/empty_slot" />
                  </tal:block>
                </div>
              </tal:block>
              <tal:block condition="content/aq_explicit/isCellBlock|nothing">
                <tal:block define="block content">
                  <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slots" />
                </tal:block>
              </tal:block>
            </tal:block>
          </td>
        </tal:block>
      </tal:block>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="unused_portlets_panel">
  <h2 i18n:translate="heading_unused_portlets" i18n:domain="cpsskins">Unused portlets</h2>
  <p i18n:translate="description_unused_portlets" i18n:domain="cpsskins">Unused portlets</p>
  <table cellpadding="0" cellspacing="3">
    <tr>
      <td valign="top" tal:repeat="hidden_slot hidden_slots">
        <div class="BoxGroupBoundingBox" 
         tal:define="group hidden_slot">
          <div tal:content="hidden_slot"
           class="BoxGroupBoxSlotTitleHidden">
          </div>
          <tal:block define="portlets python:ptltool.getPortlets(here, hidden_slot)">
            <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/box_slot" />
            <metal:block use-macro="here/cpsskins_portlet_manage_lib/macros/empty_slot" />
          </tal:block>
        </div>
      </td>
    </tr>
  </table>
</metal:block>

<metal:block define-macro="site_structure"
  tal:define="here_depth python: len(utool.getRelativeContentPath(here))">
  <h2 i18n:translate="heading_site_structure" i18n:domain="cpsskins">Site structure</h2>
  <p><span i18n:translate="description_portlets_visible_from">Portlets visible from</span>
    <span tal:content="context_url" />
  </p>
  <table border=0 width="100%" cellpadding="3" cellspacing="2">
    <tr>
      <th tal:repeat="bc here/cpsskins_getBreadcrumbs">
        <div class="PortletBoxDest"
         tal:attributes="dest_rurl bc/rpath;
                         dest_ypos python: 0">
          <a href="" tal:content="bc/longtitle" 
           tal:attributes="href string:/${bc/rpath}/portlet_manage_form" />
        </div>
      </th>
    </tr>
    <tal:block define="portlets python:ptltool.getPortlets(context=here)"
               repeat="portlet portlets">
      <tr tal:define="ypos portlet/getOrder;
                      fti portlet/getTypeInfo;
                      portlet_id portlet/getId;
                      portlet_title portlet/title_or_id;
                      portlet_type fti/title_or_id;
                      portlet_icon fti/getIcon;
                      portlet_url portlet/getURL;
                      portlet_folder portlet/getLocalFolder;
                      portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
                      portlet_rurl portlet/getRelativeUrl;
                      portlet_depth portlet/getDepth;
                      folder_url python: base_url + utool.getRelativeUrl(here);
                      group portlet/getSlot;
                      vrange portlet/getVisibilityRange;
                      vrange_start python: vrange[0];
                      vrange_stop python: vrange[1];
                      selected python: portlet_id == selected_portlet">
        <td tal:condition="portlet_depth"
         tal:attributes="colspan python: portlet_depth"></td>
        <td style="border-bottom: 1px dotted #ccc">
          <div class="PortletBoxDrag PortletBoxEditMenu"
           tal:attributes="portlet_rurl portlet_rurl;
                           portlet_url string:${base_url}${portlet_rurl};
                           portlet_folder python: base_url + portlet_folder_rurl;
                           icon portlet_icon;
                           title portlet_title;
                           folder_url folder_url;
                           portlet_id portlet_id;
                           src_rurl portlet_folder_rurl;
                           src_ypos python: ypos and ypos or 0;
                           src_slot group">
            <div class="PortletBoxDest"
             tal:attributes="dest_rurl portlet_folder_rurl;
                             dest_ypos python: ypos and ypos or 0">
              <div class="PortletInfo"
               tal:attributes="style python: selected and 'border-style: dashed' or ''">
                <a tal:attributes="onclick string:newWindow('${base_url}${portlet_rurl}/edit_form')"
                tal:content="portlet/title_or_id" href="javascript:void(0)"/>
                (<span tal:content="group" />)
                <p>
                  <img width="16" height="16" alt=""
                   tal:condition="portlet_icon"
                   tal:attributes="src string:${base_url}${portlet_icon};
                                   title python: cpsmcat(portlet_type)" />
                  <em tal:content="structure python: cpsmcat(portlet_type)" />.
                  <span tal:content="portlet/description" />
                </p>
              </div>
            </div>
          </div>
        </td> 
        <td style="border-bottom: 1px solid #ccc"
         tal:condition="python: here_depth != portlet_depth"
         tal:attributes="colspan python: here_depth - portlet_depth">
        </td> 
      </tr>       
    </tal:block> 
  </table>    
</metal:block>

<metal:block define-macro="browser_panel">
  <h2 i18n:translate="heading_portlet_browser" i18n:domain="cpsskins">Portlet browser</h2>
  <tal:block define="portlets ptltool/listAllPortlets"
             repeat="portlet portlets">
    <tal:block define="ypos portlet/getOrder;
                       fti portlet/getTypeInfo;
                       portlet_id portlet/getId;
                       portlet_title portlet/title_or_id;
                       portlet_type fti/title_or_id;
                       portlet_icon fti/getIcon;
                       portlet_url portlet/getURL;
                       portlet_folder portlet/getLocalFolder;
                       portlet_folder_rurl python: utool.getRelativeUrl(portlet_folder);
                       portlet_rurl portlet/getRelativeUrl;
                       folder_url python: base_url + utool.getRelativeUrl(here);
                       group portlet/getSlot;
                       selected python: portlet_id == selected_portlet">
      <div class="PortletBoxEditMenu" style="padding: 2px"
       tal:attributes="portlet_rurl portlet_rurl;
                       portlet_url string:${base_url}${portlet_rurl};
                       portlet_folder python: base_url + portlet_folder_rurl;
                       icon portlet_icon;
                       title portlet_title;
                       folder_url folder_url;
                       portlet_id portlet_id;
                       src_rurl portlet_folder_rurl;
                       src_ypos python: ypos and ypos or 0;
                       src_slot group">
        <div class="PortletInfo"
         tal:attributes="style python: selected and 'border-style: dashed' or ''">
          <a tal:attributes="onclick string:newWindow('${base_url}${portlet_rurl}/cpsskins_portlet_edit')"
           tal:content="portlet/title_or_id" href="javascript:void(0)"/>
          <p>
            <img width="16" height="16" alt=""
             tal:condition="portlet_icon"
             tal:attributes="src string:${base_url}${portlet_icon};
                             title python: cpsmcat(portlet_type)" />
            <em tal:content="structure python: cpsmcat(portlet_type)" />.
            <span tal:content="portlet/description" />
          </p>
          <div class="PortletPreview"
           tal:content="structure python: portlet.render_cache(context_obj=here)" />
        </div>
      </div>
    </tal:block>
  </tal:block>
</metal:block>
